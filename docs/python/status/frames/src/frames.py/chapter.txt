! CONTROL:
	/type/
		module
	/element/
		- (control)`property-set`
		- (source/area)`1 1 363 0`
		- (coverage-zeros)`0`
		- (coverage-counters)`0`
Formatting and parsing tools for status frame transport envelopes.

This module provides conceptual definitions for Status Frame events ((project-local/factor-element)&<types#EStruct[fault.status.types.EStruct]>) and
I/O operations supporting the transmission of those events.

Status Frames are (project-local/factor-element)&<types#Frame[fault.status.types.Frame]> instances that can be serialized into and parsed from a
data stream.

[ Usage ]

The operation used to serialize and load the data extension is decoupled, so an allocation
function is provided to apply the defaults for the data extension transport:

#!syntax/python
	from fault.status import frames
	
Frame envelopes may or may not have content (data extensions):

#!syntax/python
	msg = compose('!#', "ERROR: no such resource")
	sys.stdout.write(frames.sequence(msg))
	
	"[!# ERROR: no such resource]
"

Serialized messages are expected to include the trailing newline:

#!syntax/python
	for line in sys.stdin.readlines():
		msg = frames.structure(line)
	
[ Properties ]

/protocol/
	String identifying the status frames (event) protocol.


[ typing ]
! CONTROL:
	/type/
		import
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`34 1 34 13`

[ functools ]
! CONTROL:
	/type/
		import
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`35 1 35 16`

[ base64 ]
! CONTROL:
	/type/
		import
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`36 1 36 13`

[ transport ]
! CONTROL:
	/type/
		import
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`38 1 38 23`

[ types ]
! CONTROL:
	/type/
		import
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`39 1 39 19`

[ protocol ]
! CONTROL:
	/type/
		data
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`41 1 41 51`
#!source
	protocol = 'http://fault.io/protocol/status/frames'

[ ttyn_data_url ]
! CONTROL:
	/type/
		data
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`42 1 42 56`
#!source
	ttyn_data_url = b'data:text/plain;charset=utf-8;base64,'

[ compose ]
! CONTROL:
	/type/
		function
	/element/
		- (control)`property-set`
		- (source/area)`44 1 53 39`
		- (type/syntax)`types.Frame`
		- (type/project-local/factor-element)&<types#Frame[fault.status.types.Frame]>
		
(signature)`compose(ftype, synopsis)`

Create a status frame using the envelope's symbol and synopsis.


[ _frame_pack_extension ]
! CONTROL:
	/type/
		function
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`55 1 59 60`
		- (type/syntax)`bytes`
		- (type/invalid/unknown)&<#bytes>
		
(signature)`_frame_pack_extension(data)`


[ _frame_unpack_extension ]
! CONTROL:
	/type/
		function
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`61 1 66 44`
		- (type/syntax)`object`
		- (type/invalid/unknown)&<#object>
		
(signature)`_frame_unpack_extension(data)`


[ protocol ]
! CONTROL:
	/type/
		data
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`69 1 69 51`
#!source
	protocol = "http://fault.io/protocol/status/frames"

[ type_codes ]
! CONTROL:
	/type/
		data
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`72 1 128 24`
#!source
	type_codes = {
		# [!? PROTOCOL: http://fault.io/protocol/status/frames tty-notation-1]
		"!?": 'message-protocol',
		"!&": 'reference',
	
		# Abstract Transaction progress.
		"><": 'transaction-failed',
		"<>": 'transaction-executed',
		"->": 'transaction-started',
		"--": 'transaction-event',
		"<-": 'transaction-stopped',
	
		# Warnings, Errors, and Information with respect to some conceptual level of a frame source.
		"!#": 'message-application',
		"!*": 'message-framework',
		"!~": 'message-trace',
	
		# Messages sent by user entities.
		"!%": 'message-administrative',
		"!>": 'message-entity',
	
		# Resource Content Manipulations
		"+=": 'elements-inserted', # Added
		"-=": 'elements-deleted', # Removed
		"Δ=": 'elements-delta', # Compound Change
		"<=": 'elements-reverted',
		"==": 'elements-committed',
	
		# Resource Container Manipulations
		"+.": 'resource-initialized',
		"-.": 'resource-deleted',
		"±.": 'resource-relocated',
		"*.": 'resource-replicated',
		"&.": 'resource-referenced',
		"=.": 'resource-rewritten',
		"Δ.": 'resource-delta', # Property/metadata changes.
	
		# Archive I/O
		"^*": 'archive-extraction-replicated',
		"^+": 'archive-extraction-replicated-merge',
	
		"√*": 'archive-delta-replicated-into',
		"√+": 'archive-delta-merged-into',
		"√-": 'archive-delta-deleted',
		"√&": 'archive-delta-referenced',
	
		# Transfer Snapshots.
		"↑.": 'resource-transmitted',
		"↓.": 'resource-received',
	
		# Transfer Progress Information.
		"↑:": 'data-transmitted',
		"↓:": 'data-received',
		"↓↑": 'data-transferred',
	}
	
	@functools.lru_cache(16)

[ type_integer_code ]
! CONTROL:
	/type/
		function
	/element/
		- (control)`property-set`
		- (source/area)`129 1 136 25`
		- (type/syntax)`int`
		- (type/invalid/unknown)&<#int>
		
(signature)`type_integer_code(typstring)`

Convert a two-character type code symbol into an unsigned 32-bit integer.
Currently, only supporting unicode characters in the 16-bit range.


[ type_identifier_string ]
! CONTROL:
	/type/
		function
	/element/
		- (control)`property-set`
		- (source/area)`138 1 142 71`
		- (type/syntax)`str`
		- (type/invalid/unknown)&<#str>
		
(signature)`type_identifier_string(typcode)`

Convert an integer type code into the two-character string used for serialization and display.


[ _ttyn_signature ]
! CONTROL:
	/type/
		data
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`147 1 147 35`
#!source
	_ttyn_signature = "\x1b]\x03\x1b\\"

[ _ttyn_open_url ]
! CONTROL:
	/type/
		data
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`150 1 150 40`
#!source
	_ttyn_open_url = "\x1b[34;2m" "\x1b]8;;"

[ _ttyn_close_url ]
! CONTROL:
	/type/
		data
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`151 1 151 26`
#!source
	_ttyn_close_url = "\x1b\\"

[ _ttyn_reset_url ]
! CONTROL:
	/type/
		data
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`152 1 152 51`
#!source
	_ttyn_reset_url = "\x1b]8;;" "\x1b\\" "\x1b[39;22m"

[ _frame_open ]
! CONTROL:
	/type/
		data
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`154 1 154 22`
#!source
	_frame_open = "[{ts} "

[ _frame_exit ]
! CONTROL:
	/type/
		data
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`155 1 155 19`
#!source
	_frame_exit = "]\n"

[ _loaded_frame_start ]
! CONTROL:
	/type/
		data
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`156 1 156 45`
#!source
	_loaded_frame_start = _frame_open + "{image}"

[ _loaded_frame_partition ]
! CONTROL:
	/type/
		data
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`157 1 157 45`
#!source
	_loaded_frame_partition = " ({channel}{open}"

[ _loaded_frame_stop ]
! CONTROL:
	/type/
		data
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`158 1 158 79`
#!source
	_loaded_frame_stop = "{finish}{signal}{size}{close}" + _ttyn_signature + ")]\n"

[ _empty_frame_stop ]
! CONTROL:
	/type/
		data
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`159 1 159 43`
#!source
	_empty_frame_stop = _ttyn_signature + "]\n"

[ _pack ]
! CONTROL:
	/type/
		function
	/element/
		- (control)`property-set`
		- (source/area)`161 1 213 26`
		- (type/syntax)`typing.Tuple[str, bytes, str]`
		
(signature)`_pack(frame)`

Pack a status frame for transmission.

Constructs a triple containing the leading envelope string,
the encoded bytes of data extending the frame and the terminating trailer.


[ sequence ]
! CONTROL:
	/type/
		function
	/element/
		- (control)`property-set`
		- (source/area)`215 1 227 36`
		- (type/syntax)`str`
		- (type/invalid/unknown)&<#str>
		
(signature)`sequence(frame)`

Pack a status frame into a (invalid/unknown)&<#str> for transmission.

Constructs a single (invalid/unknown)&<#str> instance.

[ > Parameters ]

/(parameter)`frame`/
	- (type/syntax)`types.Frame`
	- (type/project-local/factor-element)&<types#Frame[fault.status.types.Frame]>
	
	The status frame to be represented in serial form.

/(parameter)`channel`/
	
	(control/absent)`Undocumented`.


[ _unpack ]
! CONTROL:
	/type/
		function
	/element/
		- (control)`property-set`
		- (source/area)`229 1 312 3`
		- (type/syntax)`types.Frame`
		- (type/project-local/factor-element)&<types#Frame[fault.status.types.Frame]>
		
(signature)`_unpack(line, offset, limit)`

Unpack a serialized status frame.


[ structure ]
! CONTROL:
	/type/
		function
	/element/
		- (control)`property-set`
		- (source/area)`314 1 323 37`
		- (type/syntax)`types.Frame`
		- (type/project-local/factor-element)&<types#Frame[fault.status.types.Frame]>
		
(signature)`structure(line)`

Extract a status frame, (project-local/factor-element)&<types#Frame[fault.status.types.Frame]>, from the given (factor-local/parameter)&<#structure.Parameters.line[line]>.

[ > Parameters ]

/(parameter)`line`/
	- (type/syntax)`str`
	- (type/invalid/unknown)&<#str>
	
	A single serialized line.


[ declaration ]
! CONTROL:
	/type/
		function
	/element/
		- (control)`property-set`
		- (source/area)`325 1 342 3`
(signature)`declaration()`

Construct a custom protocol declaration message.


[ tty_notation_1_message ]
! CONTROL:
	/type/
		data
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`345 1 345 38`
#!source
	tty_notation_1_message = declaration()

[ tty_notation_1_string ]
! CONTROL:
	/type/
		data
	/flags/
		- `undocumented`
	/element/
		- (control)`property-set`
		- (source/area)`348 1 348 80`
#!source
	tty_notation_1_string = "[!? " + tty_notation_1_message.f_event.abstract + "]\n"

[ message_directed_areas ]
! CONTROL:
	/type/
		function
	/element/
		- (control)`property-set`
		- (source/area)`350 1 363 12`
(signature)`message_directed_areas(fields, start, end)`

Return the slices marking the areas before and after the first item
contained in (factor-local/parameter)&<#message_directed_areas.Parameters.arrows[arrows]>.

(invalid/unknown)&<#None> if no items in (factor-local/parameter)&<#message_directed_areas.Parameters.fields[fields]> are contained in (factor-local/parameter)&<#message_directed_areas.Parameters.arrows[arrows]>.

